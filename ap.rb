puts "Line 1: Loading SPI..."
require 'spi'
puts "Line 2: SPI loaded"

puts "Line 3: Loading GPIO..."
require 'gpio'
puts "Line 4: GPIO loaded"

# === PicoRuby互換性: String#reverseメソッドの定義 ===
# PicoRubyには String#reverse がないため、手動実装
class String
  def reverse
    result = ""
    (self.size - 1).downto(0) do |i|
      result = result + self[i]
    end
    result
  end
end

WIDTH  = 128
HEIGHT = 296

# === ディスプレイ 統合 データ ===
# QRコード(128x128) + テキスト(168x128)
# 出典: ユーザー提供
DISPLAY_WIDTH = 296
DISPLAY_HEIGHT = 128
DISPLAY_DATA = [
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111111111000011111111110000000000000000000111111111100000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111111111000011111111110000000000000000000111111111100000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111111111000011111111110000000000000000000111111111100000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111111111000011111111110000000000000000000111111111100000000000000000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000011111111111111111111111000001111111111111111111111110000000000111100000111111111100000111111111111111111111110000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111110000000000000000001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111110000000000000000001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111110000000000000000001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111110000000000000000000111110000000001111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111100000111110000011111111100000000001111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000001111100001111100000000000000111110000011111000000000000001111100001111100000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111000000000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111000000000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111000000000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000001111111111111110000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000001111111111111110000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000001111111111111110000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000001111111111111110000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000001111111111111110000000001111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111111110000111111111111111111110000111111111100001111110000000000000111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111111110000111111111111111111110000111111111100001111110000000000000111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111111110000111111111111111111110000111111111100001111110000000000000111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111000000000000001111100001111111111111110000111111111111111111110000111111111100001111110000000000000111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111111111111111111111111111111110000111111111100001111111111111111111111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111000011111111111111100000111110000000001111100001111111111111111111111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111000011111111111111100001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111000011111111111111100001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111111111000011111111111111100001111110000000001111100001111111111111111111111111000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000011111111111111111111111000001111111111111111111111111111111111111111111000001111100000111111111111111111111110000011111111111111111111111111111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111111000000011111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000111110000011111000011111000001111100000000000000000000000000000000011111111111111111111111111111111111000000011110000001111111111111111100000000001111111111111111111100000000000111111111111000000011110000001111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000111110000011111000011111100001111100000000000000000000000000000000011111111111111111111111111111111111000000011000000000011111111111100000000000000001111111111111110000000000000001111111111000000011000000000111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000111110000011111000011111100001111100000000000000000000000000000000011111111111111111111111111111111111000000010000000000001111111111000000000000000000111111111111000000000000000001111111111000000010000000000011111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100001111110000111110000011111000011111000001111100000000000000000000000000000000011111111111111111111111111111111111000000010000000000001111111111000000000000000000011111111110000000000000000001111111111000000010000000000001111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000000000000111110000000001111110010111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000000111111111000000000000000000001111111110000000000000000001111111111000000000000000000001111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000000000000111110000000001111110000111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000000011111111000001111111000000001111111100000000000000000001111111111000000000000000000001111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000000000000111110000000001111110000111111111111111111111111111111111111111111111111111111111111111111111111111111000000000011100000000011111111000111111111100000001111111100000000111111111001111111111000000000111100000000111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000000000000111110000000001111110000111111111111111111111111111111111111111111111111111111111111111111111111111111000000000111110000000011111111011111111111110000000111111100000001111111111111111111111000000001111100000000111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000000000000111110000000001111110000111111111111111111111111111111111111111111111111111111111111111111111111111111000000001111111000000011111111111111111111110000000111111100000001111111111111111111111000000001111110000000111111111111111111111111111111" ,
               "11110000000000000011111000000000000000000000000111110000000001111111111111111111000000000000001111111111111110000111111111111111111111111111111111111111111111000000001111111000000001111111111111111111110000000111111100000000111111111111111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000000000011111000000000000000000000000111110000000001111111111111111111000000000000001111111111111110000111111111111111111111111111111111111111111111000000011111111100000001111111111100000000000000000111111100000000000011111111111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000000000011111000000000000000000000000111110000000001111111111111111111000000000000001111111111111110000111111111111111111111111111111111111111111111000000011111111100000001111111100000000000000000000111111110000000000000011111111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000000000011111000000000000000000000000111110000000001111111111111111111000000000000001111111111111110000111111111111111111111111111111111111111111111000000011111111100000001111111000000000000000000000111111110000000000000000111111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000000101011111000000000001000000000000111110000000001111111111111111111000000000000001111111111111110010111111111111111111111111111111111111111111111000000011111111100000001111110000000000000000000000111111111000000000000000001111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000111110000000000111110000000001111100000111111111000000000000000000011111111111111111111000011111111111111111111111111111111111000000011111111100000001111100000000000000000000000111111111110000000000000000111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000111110000000000111110000000001111100001111111111000000000000000000011111111111111111111000011111111111111111111111111111111111000000011111111100000001111100000000011111110000000111111111111110000000000000111111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000111111000000000111110000000001111100001111111111100000000000000000011111111111111111111000011111111111111111111111111111111111000000011111111100000001111000000001111111110000000111111111111111110000000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000111110000000000111110000000001111100001111111111000000000000000000011111111111111111111000011111111111111111111111111111111111000000011111111100000001111000000011111111110000000111111111111111111110000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000111111111100000111111111111111111100000111111111000000000011111111111111111111111111111000011111111111111111111111111111111111000000001111111000000001111000000011111111110000000111111111111111111111000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000000001111100000000011111111111111100000000011111000000000011111111110000111110000000000000011111111111111111111111111111111111000000001111111000000011111000000011111111100000000111111111111111111111000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000000001111100000000011111111111111100000000011111000000000011111111110000111110000000000000011111111111111111111111111111111111000000000111110000000011111000000011111111100000000111111101111111111111000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000000001111100000000011111111111111100000000011111100000000011111111110000111110000000000000011111111111111111111111111111111111000000000011100000000011111000000001111111000000000111111100000111111100000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000000001111111111000000000000001111100000000011111111111111100000000011111000000000011111111110000111110000000000000011111111111111111111111111111111111000000000000000000000011111100000000111110000000000111111100000000000000000000011111111000000011111110000000111111111111111111111111111111" ,
               "11110000111111111111111000000000111111111111111111111111111111111100000000011111111110000011111111100000111111111100001111111111111111111111111111111111111111000000000000000000000111111100000000000000000000000111111100000000000000000000111111111000000011111110000000111111111111111111111111111111" ,
               "11110000111111111100000000000000111110000011111111111111100001111100000000011111111110000000000000000000111111111100001111111111111111111111111111111111111111000000010000000000001111111110000000000000000000000111111100000000000000000000111111111000000011111110000000111111111111111111111111111111" ,
               "11110000111111111100000000000000111111000011111111111111100001111100000000011111111110000000000000000000111111111100001111111111111111111111111111111111111111000000010000000000001111111110000000000000010000000111111100000000000000000001111111111000000011111110000000111111111111111111111111111111" ,
               "11110000111111111100000000000000111110000011111111111111100001111100000000011111111110000000000000000000111111111100001111111111111111111111111111111111111111000000011000000000011111111111100000000000110000000111111110000000000000000111111111111000000011111110000000111111111111111111111111111111" ,
               "11110000111111111100000000000000111110000011111111111111100001111100000000011111111110000000000000000000111111111100001111111111111111111111111111111111111111111111111110000001111111111111111000000011111111111111111111111000000000011111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111100000000000000000000000011111111111111111110000000000000011111100000000000000000011111000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111100000000000000000000000011111111111111111110000000000000011111000000000000000000011111000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111100000000000000000000000011111111111111111110000000000000011111000000000000000000011111000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111100000000000000000000000011111111111111111110000000000000011111000000000000000000011111000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111100000000000000000000000011111111111111111110000000000000011111000000000000000000011111000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000000000000011111111111000000000000011111100000000000000000011111000000000000001111111111000001111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000000000000011111111110000000000000011111100000000000000000011111100000000000001111111111000001111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000000000000011111111111000000000000011111100000000000000000011111000000000000001111111111000001111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000000000000011111111110000000000000011111100000000000000000011111000000000000001111111111000001111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111110000011111000011111111111111100000000011111100000000000000111111111111111111100001111111111111111111111111000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000011111000011111100001111100000000011111100000000000001111111111111111111100000000011111111110000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000011111000011111100001111100000000011111100000000000001111111111111111111100000000011111111110000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000011111000011111100001111100000000011111100000000000001111111111111111111100000000011111111110000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000011111000001111100001111100000000011111100000000000001111111111111111111100000000011111111110000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111110000011111111111111111111111100000111111111111110000000000111111111111111111100001111111111111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000011111111111111111111111100000111110000111110000000000000011111000001111100001111110000111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000011111111111111111111111100000111110000111110000000000000011111000001111100001111110000111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000011111111111111111111111100000111110000111110000000000000011111000001111100001111110000111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111100000000011111111111111111111111100000111110000111110000000000000011111100001111100001111110000111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000111110000000001111100000111111111100001111111111000000000000000100000000000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000111110000000001111100000111111111100001111111111000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000111110000000001111100000111111111100001111111111000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000111110000000001111100000111111111100001111111111000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111000000000111110000000001111100000111111111100001111111111000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000111111111100001111111111111110000000001111111111111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000111111111100001111111111111110000000001111111111111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000111111111100001111111111111110000000001111111111111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000111111111100001111111111111110000000001111111111111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111100000111111111101001111111111111110000000001111111111111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000000011111111111111100001111110000000001111100001111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000000011111111111111100001111110000000001111100001111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000000011111111111111100001111110000000001111100001111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000000011111111111111100000111110000000001111100001111110000000001111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000011111111111111111111111100001111100000000001111111111111111111111110000000001111111111111110000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000000001111111111111110000000001111111111111110000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000000001111111111111110000000001111111111111110000000001111111111111111111111111111111111111111111111111111111111111001111111111111111111111111111111111111111110011111111111111100000111111111100000011111000000000001111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000000001111111111111110000000001111111111111110000000001111111111111111111111111111111111111111111111111111111111111001111111111111111111111111111111111111111110011111111111111000000011111111000000001111000000000001111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000000001111111111111110000000001111111111111110000000001111111111111111111111111111111111111111111111111110000001111001111111111111111111111111111111111111111110011111111111110001110001111110001111101111111111110011111111111111111111111111111" ,
               "11110000111111011111111111111111100001111100000000000000111111111111111111111111000001111111111111100000000001111101111111011111111111111111111111111111111111100000000111001111111111111111111111111111111111111111110011111111111110011111001111100111111111111111111110011111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111111111111100000000000000000000000000001111100000000011111111111111111111111111111111110000111100011001111111111111111111111111111111111111111110011111111111100011111000111100111111111111111111100011111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111111111111000000000000000000000000000001111100000000011111111111111111111111111111111110011111110001001100001111111110000001111111100000001111110011000001111100111111100111001111111111111111111100111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111111111111000000000000000000000000000001111100000000011111111111111111111111111111111100111111111001000000000111111100000000011111000000000111110010000000111100111111100111001111111111111111111100111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000000000000111110000011111111111111000000000000000000000000000001111100000000011111111111111111111111111111111100111100001001000011100011111101111110001110001111110111110000111100011100111111100111001111111111111111111001111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000000000000001111111111111111111111111000000000000000000111111111111111111111111111111111111111111001111000000001000111110001111111111111001110011111111111110001111110011100110001100111001111111111111111111001111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000000000000001111111111111111111111111000000000000000000111111111111111111111111111111111111111111001110001110001001111111001111111111111001110001111111111110011111110011100110001100111001111111111111111110001111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000000000000001111111111111111111111111000000000000000000111111111111111111111111111111111111111111001110011111001001111111001111111000000001110000000111111110011111110011100111111100111001111111111111111110011111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000000000000001111111111111111111111111000000000000000000111111111111111111111111111111111111111111001110011111001001111111001111100000000001111100000000111110011111110011100111111100111001111111111111111110011111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111111111000000000000000000000001111111111111111111111111000000000000000000111111111111111111111111111111111111111111001110011111001001111111001111000111111001111111110000011110011111110011100111111100111001111111111111111100111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000111111111100000000011111000000000111111111111111111110000111111111111111000011111111111111111111111111111111001110011111001001111111001111001111111001111111111110011110011111110011100011111001111100111111111111111100111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000111111111100000000011111000000000111111111111111111110000111111111111111000011111111111111111111111111111111001110001110001000111110001111001111110001111111111110011110011111110011110011111001111100111111111111111000111111111111111111111111111111111" ,
               "11110000111111000000000000011111100001111100000111111111100000000011111000000000111111111111111111110000111111111111111000011111111111111111111111111111111000111000000001000011100011111000111100001110011111100011110011111110011110001110001111110001111101111111001111111111111111111111111111111111" ,
               "11110000111111000000000000001111100001111100000111111111100000000011111000000000111111111111111111110000111111111111111000011111111111111111111111111111111100111100001001000000000111111100000001001110000000000111110011111110011111000000011111111000000001111111001111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000111111111111110000011111000000000111111111111111111110000111111111111111111111111111111111111111111111111111100011111111111001100001111111110000011001111100000011111110011111110011111100000111111111100000011111110011111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000111110000000000000000000000001111100001111110000000001111100001111111111111111111111111111111111111110001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000111110000000000000000000000001111100001111110000000001111100001111111111111111111111111111111111111111000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000111110000000000000000000000001111100001111110000000001111100001111111111111111111111111111111111111111100000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000111111111111111111111111100001111100000000000000111110000000000000000000000001111100001111110000000001111100001111111111111111111111111111111111111111111000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000011111111111111111111111000001111100000111110000111111111111111000000000000001111111111111111111111111111100001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000000001111111111000000000000000000011111000011111111111111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000000001111111111000000000000000000011111000011111111111111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000000001111111111000000000000000000011111000011111111111111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11110000000000000000000000000000000001111100000111110000000001111111111000000000000000000011111000011111111111111100000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" ,
               "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"
               ]

def send_command(spi, cs, dc, cmd, label = "")
  dc.write(0); cs.write(0); spi.write(cmd.chr); cs.write(1)
end

def send_data(spi, cs, dc, data, label = "")
  dc.write(1); cs.write(0); spi.write(data); cs.write(1)
end

def send_data_chunked(spi, cs, dc, data, label = "")
  dc.write(1); cs.write(0)
  i = 0
  while i < data.size
    chunk_size = data.size - i < 1024 ? data.size - i : 1024
    spi.write(data[i, chunk_size])
    i += 1024
  end
  cs.write(1)
end

def wait_until_idle(busy)
  sleep_ms(10)
  while busy.read == 0; sleep_ms(10); end
end

# === Drawing Primitives ===

# set_pixel: フレームバッファ内の単一ピクセルを設定
def set_pixel(fb, x, y, color)
  return if x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT
  byte_idx = (y * WIDTH + x) / 8
  bit_idx = 7 - (x % 8)
  old_val = fb[byte_idx].ord
  if color == 0
    new_val = old_val & ~(1 << bit_idx)
  else
    new_val = old_val | (1 << bit_idx)
  end
  fb[byte_idx] = new_val.chr
end

# fill_rect: 矩形領域を塗りつぶす
def fill_rect(fb, x, y, width, height, color)
  (0...height).each do |dy|
    (0...width).each do |dx|
      set_pixel(fb, x + dx, y + dy, color)
    end
  end
end

# draw_line: Bresenham アルゴリズムで直線を描画
def draw_line(fb, x0, y0, x1, y1, color)
  dx = (x1 - x0).abs
  dy = (y1 - y0).abs
  sx = x0 < x1 ? 1 : -1
  sy = y0 < y1 ? 1 : -1

  if dy == 0
    fill_rect(fb, [x0, x1].min, y0, (dx + 1), 1, color)
    return
  end

  if dx == 0
    fill_rect(fb, x0, [y0, y1].min, 1, (dy + 1), color)
    return
  end

  if dx > dy
    err = dx / 2
    y = y0
    x = x0
    while true
      set_pixel(fb, x, y, color)
      break if x == x1
      err -= dy
      if err < 0
        y += sy
        err += dx
      end
      x += sx
    end
  else
    err = dy / 2
    x = x0
    y = y0
    while true
      set_pixel(fb, x, y, color)
      break if y == y1
      err -= dx
      if err < 0
        x += sx
        err += dy
      end
      y += sy
    end
  end
end

# draw_display: 統合ビットマップデータを転置して描画
# 物理画面 296x128 → フレームバッファ 128x296
# display_data は配列形式 (各行は文字列)
def draw_display(fb, display_data_array, display_width, display_height)
  display_height.times do |y|  # 0-127
    row = display_data_array[y].reverse  # y番目の行を取得して反転
    display_width.times do |x|  # 0-295
      bit = row[x]  # row[x] で x 番目の文字取得
      color = (bit == '1') ? 1 : 0

      set_pixel(fb, y, x, color)
    end
  end
end

# draw_checkerboard: 市松模様を描画（描画システムの検証用）
# experiment.rb と同じ set_pixel ベースパターン
def draw_checkerboard(fb, x, y, width, height, cell_size)
  (height / cell_size).times do |row|
    (width / cell_size).times do |col|
      # 市松模様パターン
      color = (row + col) % 2 == 0 ? 0 : 1  # 黒 or 白

      # セルを塗りつぶす（set_pixel で1ピクセルずつ）
      cell_size.times do |dy|
        cell_size.times do |dx|
          px = x + col * cell_size + dx
          py = y + row * cell_size + dy
          set_pixel(fb, px, py, color)
        end
      end
    end
  end
end

# draw_circle: Midpoint Circle アルゴリズムで円を描画
def draw_circle(fb, cx, cy, radius, color, filled = false)
  x = radius
  y = 0
  d = 3 - 2 * radius

  while x >= y
    if filled
      draw_line(fb, cx - x, cy + y, cx + x, cy + y, color)
      draw_line(fb, cx - x, cy - y, cx + x, cy - y, color) if y != 0
      draw_line(fb, cx - y, cy + x, cx + y, cy + x, color) if x != y
      draw_line(fb, cx - y, cy - x, cx + y, cy - x, color) if y != 0 && x != y
    else
      set_pixel(fb, cx + x, cy + y, color)
      set_pixel(fb, cx - x, cy + y, color)
      set_pixel(fb, cx + x, cy - y, color)
      set_pixel(fb, cx - x, cy - y, color)
      set_pixel(fb, cx + y, cy + x, color)
      set_pixel(fb, cx - y, cy + x, color)
      set_pixel(fb, cx + y, cy - x, color) if x != y
      set_pixel(fb, cx - y, cy - x, color) if x != y
    end

    if d < 0
      d = d + 4 * y + 6
    else
      d = d + 4 * (y - x) + 10
      x -= 1
    end
    y += 1
  end
end

# === 初期化 ===
puts "Line 220: Starting initialization..."
spi = SPI.new(unit: :RP2040_SPI0, frequency: 2_000_000, sck_pin: 18, copi_pin: 19, mode: 0)
puts "Line 221: SPI initialized"
puts "Line 222: Initializing GPIO pins..."
cs   = GPIO.new(17, GPIO::OUT); cs.write(1)
dc   = GPIO.new(20, GPIO::OUT)
rst  = GPIO.new(21, GPIO::OUT); rst.write(1)
busy = GPIO.new(26, GPIO::IN)
pwr3v3 = GPIO.new(10, GPIO::OUT); pwr3v3.write(1)
puts "Line 228: GPIO pins initialized"

# ハードウェア リセット
puts "Line 230: Performing hardware reset..."
rst.write(0); sleep_ms(200); rst.write(1); sleep_ms(200)
wait_until_idle(busy)
puts "Line 233: Hardware reset complete"

# UC8151C 初期化（128x296モード）
puts "Line 235: Starting UC8151 initialization..."
send_command(spi, cs, dc, 0x00, "PSR")
send_data(spi, cs, dc, "\x5F", "PSR.data")
puts "Line 238: PSR configured"

send_command(spi, cs, dc, 0x01, "PWR")
send_data(spi, cs, dc, "\x03\x00\x2b\x2b\x1e", "PWR.data")

send_command(spi, cs, dc, 0x06, "BTST")
send_data(spi, cs, dc, "\x17\x17\x17", "BTST.data")

send_command(spi, cs, dc, 0x30, "PLL")
send_data(spi, cs, dc, "\x3c", "PLL.data")

send_command(spi, cs, dc, 0x04, "PON")
wait_until_idle(busy)

send_command(spi, cs, dc, 0x61, "TRES")
send_data(spi, cs, dc, "\x80\x01\x28", "TRES.data")

send_command(spi, cs, dc, 0x50, "CDI")
send_data(spi, cs, dc, "\x13", "CDI.data")

send_command(spi, cs, dc, 0x60, "TCON")
send_data(spi, cs, dc, "\x22", "TCON.data")

GC.start

# === フレームバッファ作成 ===
puts "Line 268: Creating framebuffer..."
@framebuffer = "\xFF" * (WIDTH * HEIGHT / 8)
puts "Line 270: Framebuffer created"

GC.start

# === Deep Clean: チップメモリをリセット ===
puts "Line 274: Starting Deep Clean..."
send_command(spi, cs, dc, 0x10, "DTM1")
send_data_chunked(spi, cs, dc, "\x00" * 4736, "DTM1_all_black")
puts "Line 277: DTM1 sent"

send_command(spi, cs, dc, 0x13, "DTM2")
send_data_chunked(spi, cs, dc, "\xFF" * 4736, "DTM2_all_white")

send_command(spi, cs, dc, 0x12, "DRF")
wait_until_idle(busy)

GC.start

# === 描画実行 ===
draw_display(@framebuffer, DISPLAY_DATA, DISPLAY_WIDTH, DISPLAY_HEIGHT)
GC.start

# === 画面更新 ===
send_command(spi, cs, dc, 0x10, "DTM1")
send_data_chunked(spi, cs, dc, "\xFF" * 4736, "DTM1.data")

GC.start

send_command(spi, cs, dc, 0x13, "DTM2")
send_data_chunked(spi, cs, dc, @framebuffer, "DTM2.data")

GC.start

send_command(spi, cs, dc, 0x12, "DRF")
wait_until_idle(busy)
sleep_ms(1000)

send_command(spi, cs, dc, 0x02, "POF")

GC.start

puts "Done: bash0C7 namecard displayed"
